<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="enamad" content="61081844" />
    <title>Medical ProMax | پلتفرم تخصصی سوالات پزشکی</title>

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .medical-gradient {
            background: radial-gradient(1200px 600px at 100% 0%, rgba(59,130,246,.25), transparent 60%),
                        radial-gradient(900px 500px at 0% 40%, rgba(16,185,129,.18), transparent 60%),
                        linear-gradient(135deg, #0f172a 0%, #111827 100%);
        }
        
        .glass {
            background: rgba(255,255,255,.78);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,.35);
        }
        
        .option-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .option-card:active {
            transform: scale(.98);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(14px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .analysis-section {
            border-right: 4px solid rgba(59,130,246,.9);
            animation: slideIn 0.22s ease-out;
        }
        
        .section-card {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .section-card:hover {
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" oncontextmenu="return false;">
    <div id="app"></div>

    <script>
        const CONFIG = {
            brand: "Medical ProMax",
            exam: "آمادگی آزمون ارتقا و پره‌انترنی"
        };

        const manifest = {
            sections: [
                {
                    id: "heart",
                    title: "قلب",
                    icon: "heart",
                    color: "from-rose-600 to-red-600",
                    subsections: [
                        { id: "ihd", title: "ایسکمیک (IHD/CAD)", path: "data/heart/ihd.json" },
                        { id: "valvular", title: "دریچه‌ای", path: "data/heart/valvular.json" },
                        { id: "heart_failure", title: "نارسایی و کاردیومیوپاتی", path: "data/heart/heart_failure.json" },
                        { id: "pericardial", title: "پریکارد", path: "data/heart/pericardial.json" },
                        { id: "arrhythmia", title: "آریتمی و هدایت", path: "data/heart/arrhythmia.json" },
                        { id: "vascular_congenital", title: "عروقی و مادرزادی", path: "data/heart/vascular_congenital.json" }
                    ]
                },
                {
                    id: "icu",
                    title: "ICU",
                    icon: "activity",
                    color: "from-amber-500 to-orange-600",
                    subsections: [
                        { id: "shock_hemodynamics", title: "شوک و همودینامیک", path: "data/icu/shock_hemodynamics.json" },
                        { id: "ventilation_airway", title: "ونتیلاسیون و راه‌هوایی", path: "data/icu/ventilation_airway.json" },
                        { id: "icu_infections", title: "عفونت‌های ICU", path: "data/icu/icu_infections.json" },
                        { id: "adrenal_metabolic", title: "آدرنال و بحران‌های متابولیک", path: "data/icu/adrenal_metabolic.json" },
                        { id: "hypoxia_physiology", title: "فیزیولوژی هیپوکسی", path: "data/icu/hypoxia_physiology.json" }
                    ]
                },
                {
                    id: "lung",
                    title: "ریه",
                    icon: "wind",
                    color: "from-cyan-500 to-blue-500",
                    subsections: [
                        { id: "obstructive", title: "انسدادی (آسم/COPD)", path: "data/lung/obstructive.json" },
                        { id: "infections_pleura", title: "عفونی و پلور", path: "data/lung/infections_pleura.json" },
                        { id: "ild_occupational", title: "ILD و شغلی", path: "data/lung/ild_occupational.json" },
                        { id: "pulmonary_vascular", title: "عروق ریوی (PTE/PH)", path: "data/lung/pulmonary_vascular.json" },
                        { id: "sleep_disorders", title: "اختلالات خواب (OSA)", path: "data/lung/sleep_disorders.json" }
                    ]
                },
                {
                    id: "nephro",
                    title: "نفرو",
                    icon: "droplets",
                    color: "from-blue-600 to-cyan-600",
                    subsections: [
                        { id: "aki_nephrotoxins", title: "AKI و نفروتوکسین", path: "data/nephro/aki_nephrotoxins.json" },
                        { id: "glomerular_structural", title: "گلومرولی و ساختاری", path: "data/nephro/glomerular_structural.json" },
                        { id: "ckd_dialysis", title: "CKD و دیالیز", path: "data/nephro/ckd_dialysis.json" },
                        { id: "electrolytes_acidbase", title: "الکترولیت و اسیدبیس", path: "data/nephro/electrolytes_acidbase.json" },
                        { id: "stones_uti", title: "سنگ و UTI", path: "data/nephro/stones_uti.json" },
                        { id: "transplant", title: "پیوند کلیه", path: "data/nephro/transplant.json" }
                    ]
                }
            ]
        };

        // State management
        const state = {
            view: 'dashboard',
            section: null,
            subsection: null,
            index: 0,
            currentQuestions: [],
            answers: {},
            showAnalysis: false
        };

        const questionCountCache = {};

        function save() {
            try {
                sessionStorage.setItem('state', JSON.stringify({
                    view: state.view,
                    section: state.section,
                    subsection: state.subsection,
                    index: state.index,
                    answers: state.answers
                }));
            } catch (e) {
                console.error('Error saving state:', e);
            }
        }

        function load() {
            try {
                const data = JSON.parse(sessionStorage.getItem('state'));
                if (data) {
                    state.view = data.view || 'dashboard';
                    state.section = data.section;
                    state.subsection = data.subsection;
                    state.index = data.index || 0;
                    state.answers = data.answers || {};
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
        }

        async function getQuestionCount(path) {
            if (questionCountCache[path]) {
                return questionCountCache[path];
            }
            try {
                const response = await fetch(path);
                const data = await response.json();
                const count = (data.questions || []).length;
                questionCountCache[path] = count;
                return count;
            } catch (e) {
                console.error('Error fetching:', path, e);
                return 0;
            }
        }

        function render() {
            const root = document.getElementById('app');
            if (state.view === 'dashboard') root.innerHTML = viewDashboard();
            else if (state.view === 'subsections') root.innerHTML = viewSubsections();
            else if (state.view === 'quiz') root.innerHTML = viewQuiz();
            lucide.createIcons();
        }

        function viewDashboard() {
            return `
                <div class="min-h-screen medical-gradient py-12 px-4">
                    <div class="max-w-6xl mx-auto">
                        <div class="text-center mb-16">
                            <h1 class="text-5xl font-black text-white mb-3">${CONFIG.brand}</h1>
                            <p class="text-xl text-blue-100">${CONFIG.exam}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${manifest.sections.map(section => `
                                <div class="section-card glass rounded-3xl p-8 shadow-xl hover:shadow-2xl transition" onclick="selectSection('${section.id}')">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="p-4 bg-gradient-to-br ${section.color} rounded-2xl">
                                            <i data-lucide="${section.icon}" class="w-8 h-8 text-white"></i>
                                        </div>
                                        <h2 class="text-2xl font-bold text-slate-800">${section.title}</h2>
                                    </div>
                                    <p class="text-slate-600 mb-4">${section.subsections.length} بخش</p>
                                    <button class="w-full px-6 py-3 bg-gradient-to-r ${section.color} text-white rounded-xl font-bold hover:shadow-lg transition">
                                        مشاهده سوالات
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function selectSection(sectionId) {
            state.section = sectionId;
            state.view = 'subsections';
            state.subsection = null;
            state.index = 0;
            state.currentQuestions = [];
            state.answers = {};
            save();
            render();
            window.scrollTo(0, 0);
        }

        function viewSubsections() {
            const section = manifest.sections.find(s => s.id === state.section);
            if (!section) return '<div>خطا</div>';

            return `
                <div class="min-h-screen bg-gradient-to-b from-blue-50 to-slate-50 py-8 px-4">
                    <div class="max-w-4xl mx-auto">
                        <button onclick="goBack()" class="flex items-center gap-2 text-blue-600 font-bold mb-8 hover:text-blue-700">
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            بازگشت
                        </button>
                        
                        <h1 class="text-4xl font-black text-slate-800 mb-12">${section.title}</h1>
                        
                        <div class="space-y-4">
                            ${section.subsections.map(sub => `
                                <div class="glass rounded-2xl p-6 shadow-lg hover:shadow-xl transition cursor-pointer" 
                                     onclick="selectSubsection('${sub.id}', '${sub.path.replace(/"/g, '\\\"')}')">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-xl font-bold text-slate-800">${sub.title}</h3>
                                        <i data-lucide="chevron-left" class="w-6 h-6 text-slate-400"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function selectSubsection(subId, path) {
            state.subsection = subId;
            state.view = 'quiz';
            state.index = 0;
            state.answers = {};
            state.showAnalysis = false;
            
            fetch(path)
                .then(r => r.json())
                .then(data => {
                    state.currentQuestions = data.questions || [];
                    save();
                    render();
                    window.scrollTo(0, 0);
                })
                .catch(e => {
                    console.error('خطا در بارگیری سوالات:', e);
                    alert('خطا در بارگیری سوالات!');
                });
        }

        function viewQuiz() {
            if (!state.currentQuestions.length) {
                return `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-xl text-slate-600">بارگیری سوالات...</p>
                        </div>
                    </div>
                `;
            }

            const q = state.currentQuestions[state.index];
            const selectedIdx = state.answers[state.index];
            const isAnswered = selectedIdx !== undefined;

            return `
                <div class="min-h-screen bg-gradient-to-b from-blue-50 to-slate-50 py-8 px-4">
                    <div class="max-w-3xl mx-auto">
                        <button onclick="goBack()" class="flex items-center gap-2 text-blue-600 font-bold mb-6 hover:text-blue-700">
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            بازگشت
                        </button>

                        <!-- Progress -->
                        <div class="mb-8">
                            <div class="flex justify-between text-sm text-slate-600 mb-2">
                                <span>سوال ${state.index + 1} از ${state.currentQuestions.length}</span>
                                <span>${Math.round((state.index / state.currentQuestions.length) * 100)}%</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all" style="width: ${(state.index / state.currentQuestions.length) * 100}%"></div>
                            </div>
                        </div>

                        <!-- Question -->
                        <div class="glass rounded-3xl p-8 shadow-xl mb-8">
                            <h2 class="text-2xl font-bold text-slate-800 mb-8 leading-relaxed">${q.question}</h2>

                            <!-- Options -->
                            <div class="space-y-3">
                                ${q.options.map((opt, idx) => `
                                    <div class="option-card glass rounded-xl p-6 cursor-pointer transition
                                        ${isAnswered && idx === q.correct_index ? 'border-2 border-green-500 bg-green-50' : ''}
                                        ${isAnswered && selectedIdx === idx && idx !== q.correct_index ? 'border-2 border-red-500 bg-red-50' : ''}
                                        ${!isAnswered ? 'hover:bg-white hover:border-2 hover:border-blue-300' : ''}"
                                        ${!isAnswered ? `onclick="pick(${state.index}, ${idx})"` : ''}>
                                        <div class="flex items-start gap-4">
                                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0 font-bold text-slate-600 ${isAnswered && idx === q.correct_index ? 'bg-green-200 text-green-700' : ''} ${isAnswered && selectedIdx === idx && idx !== q.correct_index ? 'bg-red-200 text-red-700' : ''}">
                                                ${String.fromCharCode(65 + idx)}
                                            </div>
                                            <p class="text-lg text-slate-800 leading-relaxed">${opt}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Analysis -->
                            ${isAnswered && !state.showAnalysis ? `
                                <button onclick="toggleAnalysis()" class="w-full mt-8 px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">
                                    <i data-lucide="book-open" class="inline w-5 h-5 ml-2"></i>
                                    نمایش تحلیل
                                </button>
                            ` : ''}

                            ${state.showAnalysis && isAnswered ? `
                                <div class="analysis-section mt-8 p-6 bg-blue-50 rounded-2xl">
                                    <h3 class="text-lg font-bold text-blue-900 mb-4">تحلیل:</h3>
                                    <p class="text-slate-700 mb-6 leading-relaxed">${q.analysis?.points || ''}</p>
                                    <div class="space-y-3">
                                        ${(q.analysis?.options || []).map((ana, idx) => `
                                            <div class="flex gap-4 p-4 ${idx === q.correct_index ? 'bg-green-100 rounded-lg' : ''}">
                                                <span class="font-bold text-slate-700 flex-shrink-0">${String.fromCharCode(65 + idx)}:</span>
                                                <p class="text-slate-700">${ana}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Navigation -->
                        <div class="flex gap-4 justify-between">
                            <button onclick="prev()" ${state.index === 0 ? 'disabled' : ''} class="flex-1 px-6 py-3 bg-slate-300 text-slate-800 rounded-xl font-bold hover:bg-slate-400 transition disabled:opacity-50">
                                <i data-lucide="arrow-right" class="inline w-5 h-5 ml-2"></i>
                                قبلی
                            </button>
                            <button onclick="next()" ${state.index === state.currentQuestions.length - 1 ? 'disabled' : ''} class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition disabled:opacity-50">
                                بعدی
                                <i data-lucide="arrow-left" class="inline w-5 h-5 mr-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function goBack() {
            state.view = state.view === 'subsections' ? 'dashboard' : 'subsections';
            state.index = 0;
            state.currentQuestions = [];
            state.answers = {};
            state.showAnalysis = false;
            save();
            render();
            window.scrollTo(0, 0);
        }

        function toggleAnalysis() {
            state.showAnalysis = !state.showAnalysis;
            render();
        }

        function pick(idx, answerIdx) {
            if (state.answers[idx] !== undefined) return;
            state.answers[idx] = answerIdx;
            save();
            render();
        }

        function next() {
            if (state.index < state.currentQuestions.length - 1) {
                state.index++;
                state.showAnalysis = false;
                save();
                render();
                window.scrollTo(0, 0);
            }
        }

        function prev() {
            if (state.index > 0) {
                state.index--;
                state.showAnalysis = false;
                save();
                render();
                window.scrollTo(0, 0);
            }
        }

        // بارگیری وضعیت قبلی و رندر
        load();
        render();
    </script>
</body>
</html>
